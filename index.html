<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶ï DinoRun Pro</title>
    
    <!-- Preconnect to Quick Auth Server for performance -->
    <link rel="preconnect" href="https://auth.farcaster.xyz">
    
    <!-- Farcaster Mini App Meta Tags -->
    <meta property="fc:miniapp" content='{
        "version": "1",
        "imageUrl": "https://dino-run-mini-app.vercel.app/screenshot.png",
        "button": {
            "title": "ü¶ï Play DinoRun",
            "action": {
                "type": "link",
                "url": "https://dino-run-mini-app.vercel.app"
            }
        }
    }'>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #2E8B57;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .score-display {
            font-size: 1.5em;
            color: #2E8B57;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        #gameCanvas {
            border: 3px solid #2E8B57;
            border-radius: 15px;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 100%);
            cursor: pointer;
            display: block;
            margin: 0 auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        .controls-info {
            margin-top: 20px;
            color: #666;
            font-size: 1.1em;
        }
        
        .game-start-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 10;
            border: 3px solid #4CAF50;
        }
        
        .game-start-message h2 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 1.8em;
        }
        
        .game-start-message p {
            margin: 8px 0;
            font-size: 1.1em;
        }
        
        .canvas-wrapper {
            position: relative;
            display: inline-block;
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            #gameCanvas {
                width: 100%;
                max-width: 400px;
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ü¶ï DinoRun Pro</h1>
        
        <div class="score-display">
            Score: <span id="score">0</span> | High: <span id="highScore">0</span>
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="600" height="300"></canvas>
            <div id="gameStartMessage" class="game-start-message">
                <h2>ü¶ï DinoRun Pro</h2>
                <p>Get Ready!</p>
                <p>üñ±Ô∏è Click or Touch to Jump</p>
                <p>‚å®Ô∏è Spacebar to Jump</p>
                <p>üéÆ Game starts in 2 seconds...</p>
            </div>
        </div>
        
        <div class="controls-info">
            <p><strong>üéÆ Controls:</strong> Click/Touch or SPACE to jump over obstacles!</p>
            <p><strong>üéØ Goal:</strong> Survive as long as possible and get the highest score!</p>
        </div>
    </div>
    
    <!-- Farcaster Mini App SDK -->
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
        
        // Make SDK globally available
        window.farcasterSDK = sdk;
        
        // Initialize the app following official documentation
        async function initializeApp() {
            try {
                console.log('üöÄ Initializing Farcaster Mini App...');
                
                // Wait for game to be ready
                await waitForGameReady();
                
                // Try to authenticate user with Quick Auth (optional)
                try {
                    const { token } = await sdk.quickAuth.getToken();
                    console.log('‚úÖ Quick Auth successful, user authenticated');
                    window.userToken = token;
                } catch (authError) {
                    console.log('‚ö†Ô∏è Quick Auth failed, continuing without authentication:', authError.message);
                    // Continue without auth - app should still work
                }
                
                // Call ready() to hide splash screen - THIS IS CRITICAL
                await sdk.actions.ready();
                console.log('‚úÖ App is ready! Splash screen should be hidden.');
                
            } catch (error) {
                console.error('‚ùå SDK initialization failed:', error);
                
                // Fallback: Force hide splash screen after delay
                setTimeout(() => {
                    console.log('üîÑ Attempting to force hide splash screen...');
                    const splashSelectors = [
                        '[data-testid="splash-screen"]',
                        '.splash-screen',
                        '#splash-screen',
                        '[class*="splash"]',
                        '[class*="loading"]',
                        '.farcaster-splash'
                    ];
                    
                    splashSelectors.forEach(selector => {
                        const elements = document.querySelectorAll(selector);
                        elements.forEach(el => {
                            console.log(`Hiding element: ${selector}`);
                            el.style.display = 'none';
                            el.remove();
                        });
                    });
                }, 2000);
            }
        }
        
        // Wait for game instance to be ready
        function waitForGameReady() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max wait
                
                const checkGame = () => {
                    attempts++;
                    
                    if (window.gameInstance) {
                        console.log('üéÆ Game instance found, app is ready');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('‚è∞ Timeout waiting for game, proceeding anyway...');
                        resolve();
                    } else {
                        console.log(`‚è≥ Waiting for game to initialize... (${attempts}/${maxAttempts})`);
                        setTimeout(checkGame, 100);
                    }
                };
                
                checkGame();
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üì± DOM loaded, starting initialization...');
            initializeApp();
        });
        
        // Enhanced share function using Farcaster SDK
        window.shareScore = async function(score) {
            const shareText = `ü¶ï I just scored ${score} points in DinoRun Pro! üéÆ Can you beat my score? Play the ultimate pixel art gaming experience! üöÄ #DinoRunPro #Web3Gaming #Farcaster`;
            const shareUrl = window.location.href;
            
            try {
                // Try Farcaster SDK share first
                if (window.farcasterSDK && window.farcasterSDK.actions && window.farcasterSDK.actions.share) {
                    await window.farcasterSDK.actions.share({
                        text: shareText,
                        url: shareUrl
                    });
                    console.log('‚úÖ Shared via Farcaster SDK');
                    return;
                }
                
                // Fallback to native share API
                if (navigator.share) {
                    await navigator.share({
                        title: 'DinoRun Pro Score',
                        text: shareText,
                        url: shareUrl
                    });
                    console.log('‚úÖ Shared via native share API');
                    return;
                }
                
                // Final fallback to clipboard
                await navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
                alert('Score copied to clipboard! Share it on social media! üöÄ');
                console.log('‚úÖ Copied to clipboard');
                
            } catch (error) {
                console.error('‚ùå Share failed:', error);
                // Ultimate fallback
                try {
                    await navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
                    alert('Score copied to clipboard! Share it on social media! üöÄ');
                } catch (clipError) {
                    console.error('‚ùå Clipboard also failed:', clipError);
                    alert('Unable to share. Please copy manually: ' + shareText);
                }
            }
        };
    </script>
    
    <script src="game.js"></script>
</body>
</html>
